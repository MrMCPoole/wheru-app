<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WherU - Location Sharing App</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Share your location and communicate with friends privately">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WherU">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f0f0f0;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #install-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }
        .map-container {
            height: 400px;
            background: #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="debug-panel">
        <h2>PWA Installation Debug Panel</h2>
        <div id="debug-output"></div>
        <button id="install-btn">Install App</button>
        <button onclick="window.location.reload()" style="margin-left: 10px; padding: 8px 16px;">Refresh Page</button>
    </div>

    <div class="debug-panel">
        <h3>Basic App Interface</h3>
        <div class="map-container" id="map">
            Map will load here
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const debugOutput = document.getElementById('debug-output');
        const installBtn = document.getElementById('install-btn');
        let deferredPrompt = null;

        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            debugOutput.appendChild(div);
            console.log(`PWA Debug [${type}]: ${message}`);
        }

        // Check basic PWA requirements
        function checkPWARequirements() {
            addStatus('Starting PWA compatibility check...', 'info');
            
            // Check HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                addStatus('✓ HTTPS requirement met', 'success');
            } else {
                addStatus('✗ HTTPS required for PWA installation', 'error');
            }

            // Check service worker support
            if ('serviceWorker' in navigator) {
                addStatus('✓ Service Worker API supported', 'success');
            } else {
                addStatus('✗ Service Worker not supported', 'error');
            }

            // Check manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                addStatus('✓ Manifest link found', 'success');
                checkManifest(manifestLink.href);
            } else {
                addStatus('✗ No manifest link found', 'error');
            }

            // Check beforeinstallprompt support
            if ('BeforeInstallPromptEvent' in window) {
                addStatus('✓ Install prompt API supported', 'success');
            } else {
                addStatus('? Install prompt API support uncertain', 'warning');
            }
        }

        // Check manifest file
        async function checkManifest(url) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const manifest = await response.json();
                    addStatus('✓ Manifest file loaded successfully', 'success');
                    
                    // Check required fields
                    if (manifest.name) addStatus(`✓ Name: ${manifest.name}`, 'success');
                    else addStatus('✗ Missing name field', 'error');
                    
                    if (manifest.start_url) addStatus(`✓ Start URL: ${manifest.start_url}`, 'success');
                    else addStatus('✗ Missing start_url field', 'error');
                    
                    if (manifest.display) addStatus(`✓ Display: ${manifest.display}`, 'success');
                    else addStatus('✗ Missing display field', 'error');
                    
                    if (manifest.icons && manifest.icons.length > 0) {
                        addStatus(`✓ Icons: ${manifest.icons.length} defined`, 'success');
                        manifest.icons.forEach((icon, i) => {
                            addStatus(`  Icon ${i+1}: ${icon.sizes} (${icon.type})`, 'info');
                        });
                    } else {
                        addStatus('✗ No icons defined', 'error');
                    }
                } else {
                    addStatus(`✗ Failed to load manifest: ${response.status}`, 'error');
                }
            } catch (error) {
                addStatus(`✗ Manifest error: ${error.message}`, 'error');
            }
        }

        // Service worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    addStatus('✓ Service Worker registered successfully', 'success');
                    addStatus(`  Scope: ${registration.scope}`, 'info');
                    
                    registration.addEventListener('updatefound', () => {
                        addStatus('Service Worker update found', 'info');
                    });
                    
                } catch (error) {
                    addStatus(`✗ Service Worker registration failed: ${error.message}`, 'error');
                }
            });
        }

        // Install prompt handling
        window.addEventListener('beforeinstallprompt', (e) => {
            addStatus('✓ Install prompt triggered!', 'success');
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                addStatus(`Install prompt result: ${outcome}`, outcome === 'accepted' ? 'success' : 'warning');
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });

        window.addEventListener('appinstalled', () => {
            addStatus('✓ App installed successfully!', 'success');
        });

        // Check for existing installation
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
            addStatus('App is running in standalone mode (already installed)', 'info');
        }

        // Browser detection
        const userAgent = navigator.userAgent;
        if (userAgent.includes('Chrome')) {
            addStatus('✓ Chrome browser detected (good PWA support)', 'success');
        } else if (userAgent.includes('Firefox')) {
            addStatus('Firefox browser detected (limited PWA support)', 'warning');
        } else if (userAgent.includes('Safari')) {
            addStatus('Safari browser detected (limited PWA support)', 'warning');
        } else {
            addStatus(`Browser: ${userAgent}`, 'info');
        }

        // Initialize checks
        setTimeout(checkPWARequirements, 1000);

        // Initialize basic map
        setTimeout(() => {
            try {
                const map = L.map('map').setView([37.7749, -122.4194], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                addStatus('✓ Map initialized successfully', 'success');
            } catch (error) {
                addStatus(`Map initialization error: ${error.message}`, 'error');
            }
        }, 2000);

        // Monitor for install prompt after delay
        setTimeout(() => {
            if (!deferredPrompt) {
                addStatus('Install prompt has not appeared after 10 seconds', 'warning');
                addStatus('This could indicate: missing manifest fields, already installed, or browser limitations', 'info');
            }
        }, 10000);
    </script>
</body>
</html>